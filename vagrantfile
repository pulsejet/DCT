# -*- mode: ruby -*-
# vi: set ft=ruby :
Vagrant.configure("2") do |config|
  config.vm.define "dct-dev-t" 
  config.vm.box = "bento/ubuntu-20.04"
  config.vm.hostname = "dct"
  config.vm.provider "virtualbox" do |vb|
    vb.name = "dct-dev-t"
    vb.cpus = "8"
    vb.memory = "16384"
  end
  config.vm.provision "shell", privileged: false, inline: <<-SHELL
    sudo apt-get update
    sudo apt-get -y install gcc-10 g++-10 build-essential \
                            pkg-config python3-minimal libboost-all-dev \
                            libssl-dev libsqlite3-dev libpcap-dev \
                            libsodium-dev libz-dev \
                            liblog4cxx-dev
    sudo update-alternatives --install /usr/bin/gcc gcc /usr/bin/gcc-10 100
    sudo update-alternatives --install /usr/bin/g++ g++ /usr/bin/g++-10 100
    sudo update-alternatives --install /usr/bin/c++ c++ /usr/bin/g++-10 100
    git clone https://github.com/pollere/NDNpatches
    git clone https://github.com/named-data/ndn-cxx
    cd ndn-cxx
    git apply ../NDNpatches/patch.key-impl
    ./waf configure
    ./waf
    sudo ./waf install
    sudo ldconfig
    cd ..
    git clone https://github.com/named-data/NFD
    cd NFD
    git apply ../NDNpatches/cxx-register-bug.patch
    git submodule update --init
    ./waf configure
    ./waf
    sudo ./waf install
    sudo cp /usr/local/etc/ndn/nfd.conf.sample /usr/local/etc/ndn/nfd.conf
    cd ..
    git clone https://github.com/operantnetworks/ndn-ind
    cd ndn-ind
    git apply ../NDNpatches/patch.ndn-ind
    ./configure
    make -j
    sudo make install
    sudo ldconfig
    cd ..
    rm -rf DCT
    git clone https://github.com/tylerliu/DCT-example.git DCT 
    cd DCT/
    git checkout dev
    cd tools/
    make -j
    cd ../examples/mbps
    make -j
    wget https://github.com/pollere/DCT/releases/download/v3.0/linux-schemaCompile-bin-1.2.0.tgz
    tar -xzvf linux-schemaCompile-bin-1.2.0.tgz
    rm linux-schemaCompile-bin-1.2.0.tgz
    ./schemaCompile -o mbpsDemo.scm mbpsDemo.trust
    ../../tools/make_cert -s EdDSA -o mbpsDemo.root myNet/mbpsDemo
    ../../tools/schema_cert -o mbpsDemo.schema mbpsDemo.scm mbpsDemo.root
    ../../tools/make_cert -s EdDSA -o alice.cert myNet/mbpsDemo/operator/alice mbpsDemo.root
    ../../tools/make_cert -s EdDSA -o bob.cert myNet/mbpsDemo/operator/bob mbpsDemo.root
    ../../tools/make_cert -s EdDSA -o frontdoor.cert myNet/mbpsDemo/device/frontdoor mbpsDemo.root
    ../../tools/make_bundle -o alice.bundle mbpsDemo.root mbpsDemo.schema +alice.cert
    ../../tools/make_bundle -o bob.bundle mbpsDemo.root mbpsDemo.schema +bob.cert
    ../../tools/make_bundle -o frontdoor.bundle mbpsDemo.root mbpsDemo.schema +frontdoor.cert
    cd ../../..
    ndnsec key-gen /ndn/alice
    nfd-start || echo
  SHELL
end

